name: CI - Intelligent Deploy

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-guard:
    runs-on: ubuntu-latest

    steps:
    # ----------------------------------------------------
    # 1. Checkout Source Code
    # ----------------------------------------------------
    - name: Checkout source
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2. Setup Python Environment
    # ----------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # ----------------------------------------------------
    # 3. Install Dependencies
    # ----------------------------------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # ----------------------------------------------------
    # 4. Syntax Check (Fail Fast)
    # ----------------------------------------------------
    - name: Syntax check
      run: |
        python -m py_compile app/main.py
        python -m py_compile app/health.py
        python -m py_compile app/metrics.py

    # ----------------------------------------------------
    # 5. Docker Build (latest)
    # ----------------------------------------------------
    - name: Docker build(latest)
      run: |
        docker build -t intelligent-deploy:latest .

    # ----------------------------------------------------
    # 6. Install jq
    # ----------------------------------------------------
    - name: Install jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    # ----------------------------------------------------
    # 7. Auto-Rollback Health Validation
    # ----------------------------------------------------
    - name: Auto-Rollback Guard
      run: |
        
        chmod +x scripts/auto_rollback.sh
        ./scripts/auto_rollback.sh

    # ----------------------------------------------------
    # 8. Cleanup
    # ----------------------------------------------------
    - name: Cleanup container
      if: always()
      run: |
        docker rm -f intelligent-app || true
